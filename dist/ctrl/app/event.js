"use strict";requirejs(["jquery","doT","app/modules/Utils","app/modules/Event","app/modules/Generic","app/modules/Ticket","c/tingle/tingle.min"],(function($,doT,Utils,Event,Generic,Ticket,tingle){var generic=new Generic,utils=new Utils,event=new Event,ticket=new Ticket,evt={form_desc:"#feventdesc",form_dates:"#feventdates",form_tags:"#feventtags",form_venue:"#feventvenue",form_tickets:"#fcreateticket",lang:$("html").closest("[lang]").attr("lang")||"en",uid:utils.getValueByID("UID"),datbeg:utils.getValueByID("DATBEG"),tags_selected:[],btninterested:$("#btninterested"),btndisinterested:$("#btndisinterested"),datepicker_start:null,datepicker_end:null,modal_dates:null,modal_img:null,modal_admin_tickets:null,isTicketsLoaded:!1,init:function(){$(document).on("click","#publish",evt.publish),$(document).on("click","#btninterested",evt.attend),$(document).on("click","#btndisinterested",evt.unattend),$(document).on("click","#btnticket",evt.openViewTickets),$(document).on("change",'select[name^="TICKET_QTE"]',evt.onChangeTicketsQte),null!==document.getElementById("emode")&&evt.initEditMode(),this.initTickets(),this.loadTagsView()},initTickets:function(){evt.modal_view_tickets=new tingle.modal({footer:!0,stickyFooter:!1,closeMethods:["overlay","button","escape"],closeLabel:"Close",cssClass:["custom-class-1"],onOpen:function(){evt.loadTicketsView()},onClose:function(){},beforeClose:function(){return!0}}),evt.modal_view_tickets.setContent(document.getElementById("panel_view_tickets").innerHTML)},loadTicketsView:function(){if(!1===evt.isTicketsLoaded){var jsonObj={UID:evt.uid,DATBEG:evt.datbeg};ticket.getAllTickets(this,(function(self,model){if(null!==model&&!0===model.result){var i=0;$("#event_tickets_list").empty();var tmpl=$("#tpl_tickets").html(),tempFn=doT.template(tmpl);$.each(model.data,(function(){var maxquantity=10;try{maxquantity=parseInt(this.MAXQTE)+1,console.error(this.MAXQTE)}catch(err){console.error(err)}utils.isEmpty(maxquantity)&&(maxquantity=10);for(var selectQteText="",tq=0;tq<maxquantity;tq++)selectQteText+='<option value="'+tq+'">'+tq+"</option>";var resultText=tempFn({name:this.NAME,descl:this.DESCL,price:this.PRICE,id:this.ID,select_name:"TICKET_QTE",maxqte:selectQteText});$("#event_tickets_list").append(resultText),i++}))}}),jsonObj),evt.isTicketsLoaded=!0}},openViewTickets:function(){evt.modal_view_tickets.open()},initEditMode:function(){requirejs(["places","moment","parsley","jqsobject","flow","c/datepicker/js/datepicker.min","leaflet","app/modules/geolocation_form_map","app/modules/CropImage","app/modules/textEditor"],(function(Places,Moment,Parsley,Jqsobject,Flow,datepicker,Leaflet,Geo,CropImage,TextEditor){var editor,geo;$(document).on("click","#btncancel",evt.onCancel),$(document).on("click","#btn_edit_dates",evt.onOpenModalDates),$(document).on("click","#btn_edit_img",evt.onOpenModalImg),$(document).on("click","#btn_manage_ticket",evt.onOpenModalAdminTickets),$(document).on("submit","#feventdesc",evt.onSubmitDesc),$(document).on("submit","#feventdates",evt.onSubmitDates),$(document).on("submit","#feventvenue",evt.onSubmitVenue),$(document).on("submit","#feventtags",evt.onSubmitTags),$(document).on("submit","#fcreateticket",evt.onSubmitTickets),$(document).on("click","#btn_fcreateticket_create",evt.onCreateTicket),$(document).on("click",".fcreateticket_delete",evt.onDeleteTickets),$(document).on("click",".fcreateticket_edit",evt.onEditTicket),$(document).on("click","#btn_fcreateticket_cancel",evt.showListTicket),evt.modal_img=new tingle.modal({footer:!0,stickyFooter:!1,closeMethods:["overlay","button","escape"],closeLabel:"Close",cssClass:["custom-class-1","custom-class-2"],onOpen:function(){var options={enableExif:!0,enableZoom:!0,showZoomer:!1,viewport:{width:851,height:315},boundary:{width:851,height:315}},upload_token="6684",cropimage=new CropImage;cropimage.setOptions(options),cropimage.setUid(evt.uid),cropimage.setUploadToken("6684"),cropimage.setUploadCropZone($("#upload-demo")),$("#upload").on("change",(function(){var result;!0===cropimage.readFile(this)&&$("#upload_btn_save").css("visibility","visible")})),cropimage.setCallBack((function(message){var msg=JSON.parse(message);!0===msg.success&&(document.getElementById("back_img").src=msg.flowIdentifier,$("#upload_btn_save").css("visibility","hidden"),evt.modal_img.close())})),$(".upload-result").on("click",(function(e){cropimage.crop()})),$("#upload_btn_save").css("visibility","hidden"),cropimage.setUploadCropZone($("#upload-demo"))},onClose:function(){},beforeClose:function(){return!0}}),evt.modal_img.setContent(document.getElementById("panel_edit_img").innerHTML),(new TextEditor).init("#EVTDESC"),evt.loadTagsCombo(),(new Geo).init(),evt.modal_dates=new tingle.modal({footer:!0,stickyFooter:!1,closeMethods:["overlay","button","escape"],closeLabel:"Close",cssClass:["custom-class-1","custom-class-2"],onOpen:function(){requirejs(["c/datepicker/js/i18n/datepicker."+evt.lang],(function(datepicker_lang){var allday=$("#allday").is(":checked");evt.datepicker_start=evt.initStartCalendar(allday),evt.datepicker_end=evt.initEndCalendar(allday),null!==evt.getDateEnd()&&evt.datepicker_end.selectDate(evt.getDateEnd()),null!==evt.getDateBegin()&&evt.datepicker_start.selectDate(evt.getDateBegin())})),$("#allday").change((function(){var c=!!this.checked;evt.datepicker_start.destroy(),evt.datepicker_end.destroy(),evt.datepicker_start=evt.initStartCalendar(c),evt.datepicker_end=evt.initEndCalendar(c)}))},onClose:function(){},beforeClose:function(){return!0}}),evt.modal_dates.setContent(document.getElementById("panel_edit_dates").innerHTML),evt.modal_admin_tickets=new tingle.modal({footer:!0,stickyFooter:!1,closeMethods:["overlay","button","escape"],closeLabel:"Close",cssClass:["custom-class-1","custom-class-2"],onOpen:function(e){evt.loadTicketsCreateView(e),evt.showListTicket(e)},onClose:function(){},beforeClose:function(){return!0}}),evt.modal_admin_tickets.setContent(document.getElementById("panel_edit_admin_tickets").innerHTML)}))},onOpenModalImg:function(){evt.modal_img.open()},onOpenModalDates:function(){evt.modal_dates.open()},onOpenModalAdminTickets:function(){evt.modal_admin_tickets.open()},getDateNowPicker:function(){var now=new Date;return now.setHours(now.getHours()+2),now.setMinutes(0),now.setSeconds(0),now.setMilliseconds(0),now},getDateBegin:function(){var start_date_timestamp=$("#start_date_formatted").val();return start_date_timestamp?new Date(start_date_timestamp):null},getDateEnd:function(){var end_date_timestamp=$("#end_date_formatted").val();return end_date_timestamp?new Date(end_date_timestamp):null},initStartCalendar:function(allday){evt.getDateBegin();var firstStart=!0;return $("#start_date").datepicker({timepicker:!allday,language:evt.lang,container:"#modal_edit_dates",inline:!1,startDate:evt.getDateNowPicker(),selectDate:evt.getDateBegin(),minDate:evt.getDateNowPicker(),minutesStep:5,altField:"#start_date_formatted",altFieldDateFormat:"yyyy-mm-dd hh:ii",clearButton:!0,autoClose:!1,onSelect:function onSelect(fd,date,inst){firstStart||evt.datepicker_end.update({minDate:date}),firstStart=!1}}).data("datepicker")},initEndCalendar:function(allday){evt.getDateEnd();var firstStart=!0;return $("#end_date").datepicker({timepicker:!allday,language:evt.lang,startDate:evt.getDateNowPicker(),minDate:evt.getDateNowPicker(),minutesStep:5,altField:"#end_date_formatted",altFieldDateFormat:"yyyy-mm-dd hh:ii",clearButton:!0,autoClose:!1,position:"top left",onSelect:function onSelect(fd,date,inst){firstStart||evt.datepicker_start.update({maxDate:date}),firstStart=!1}}).data("datepicker")},loadTicketsCreateView:function(){var jsonObj={UID:evt.uid,DATBEG:evt.datbeg};ticket.getAllTickets(this,(function(self,model){if(null!==model&&!0===model.result){var i=0;$("#event_tickets_edit_list").empty();var tmpl=$("#tpl_tickets_edit").html(),tempFn=doT.template(tmpl);$.each(model.data,(function(){var resultText=tempFn({name:this.NAME,descl:this.DESCL,price:this.PRICE,qte:this.QTE,id:this.ID,select_name:"TICKET_QTE_EDIT"});$("#event_tickets_edit_list").append(resultText),i++}))}}),jsonObj)},onPublishEvent:function(self,model){null!==model&&!0===model.result?$("#panel-pub").hide():$("#btnPublish").prop("disabled",!0)},publish:function(){var jsonObj={UID:evt.uid,DATBEG:evt.datbeg};$("#publish").prop("disabled",!0),event.publishEvent(this,evt.onPublishEvent,jsonObj)},attend:function(e){e.stopPropagation(),e.preventDefault();var jsonObj={UID:evt.uid,DATBEG:evt.datbeg};return evt.btninterested.prop("disabled",!0),event.attend(this,(function(self,model){null!==model&&!0===model.result&&(evt.btninterested.css("display","none"),evt.btndisinterested.css("display","block")),evt.btninterested.prop("disabled",!1)}),jsonObj),!1},unattend:function(e){e.stopPropagation(),e.preventDefault();var jsonObj={UID:evt.uid,DATBEG:evt.datbeg};return evt.btndisinterested.prop("disabled",!0),event.unAttend(this,(function(self,model){null!==model&&!0===model.result&&(evt.btndisinterested.css("display","none"),evt.btninterested.css("display","block")),evt.btndisinterested.prop("disabled",!1)}),jsonObj),!1},loadTagsView:function(){var jsonObj={UID:this.uid,DATBEG:evt.datbeg};event.getTags(this,(function(self,model){if(null!==model&&!0===model.result){var i=0;$("#tags_list").empty();var tmpl=$("#tpl_tags").html(),tempFn=doT.template(tmpl);$.each(model.data,(function(){var resultText=tempFn({value:this.TAG,text:this.DESC});$("#tags_list").append(resultText),self.tags_selected[i]=this.TAG,i++}))}}),jsonObj)},loadTagsCombo:function(){if(null!=document.getElementById("tags")){var jsonObjLang={L:"fr"};generic.loadAllTags(this,(function(self,model){if(null!==model&&!0===model.result){var $select=$("#tags");$select.find("option").remove(),$.each(model.data,(function(){var strSelected="";$.inArray(this.value,self.tags_selected)>-1&&(strSelected="selected"),$select.append('<option value="'+this.value+'"'+strSelected+">"+this.text+"</option>")}))}}),jsonObjLang)}},onCancel:function(){var txtConfirm=document.getElementById("text_alert_cancelevent").value,r;if(1==confirm(txtConfirm)){var jsonObj={UID:evt.uid,DATBEG:evt.datbeg};event.cancelEvent(this,(function(self,model){if(null!==model&&!0===model.result){var url="/home";setTimeout((function(){window.location.href=url}),1e3)}}),jsonObj)}},onSubmitDesc:function(e){try{var instance;if(!$(evt.form_desc).parsley().isValid())return;var jsonObj=$(evt.form_desc).serializeJSON(),data_descl=$(".ql-editor").html();if("<p><br></p>"===data_descl)return void e.preventDefault();if(jsonObj.DESCL=data_descl,0===Object.keys(jsonObj).length)return;event.modifyEventDesc(this,(function(self,model){null!==model&&!0===model.result?($("#modal_edit_desc").modal("hide"),window.location.reload(!0)):alert("Erreur, veuillez reessayer !")}),jsonObj)}finally{e.preventDefault()}},onSubmitDates:function(e){try{var instance;if(!$(evt.form_dates).parsley().isValid())return;var jsonObj=$(evt.form_dates).serializeJSON();if(0===Object.keys(jsonObj).length)return;event.modifyEventDate(this,(function(self,model){null!==model&&!0===model.result&&($("#modal_edit_dates").modal("hide"),window.location.reload(!0))}),jsonObj)}finally{e.preventDefault()}},onSubmitVenue:function(e){try{var instance;if(!$(evt.form_venue).parsley().isValid())return;var jsonObj=$(evt.form_venue).serializeJSON();if(0===Object.keys(jsonObj).length)return;jsonObj.UID=evt.uid,jsonObj.DATBEG=evt.datbeg,event.modifyEventVenue(this,(function(self,model){null!==model&&!0===model.result&&($("#wvenue").modal("hide"),window.location.reload(!0))}),jsonObj)}catch(e){console.log(e)}finally{e.preventDefault()}},onSubmitTags:function(e){try{var instance;if(!$(evt.form_tags).parsley().isValid())return;var jsonObj=$(evt.form_tags).serializeJSON();if(0===Object.keys(jsonObj).length)return;event.modifyEventTags(this,(function(self,model){null!==model&&!0===model.result&&(evt.loadTagsView(),$("#modal_edit_tags").modal("hide"))}),jsonObj)}finally{e.preventDefault()}},onSubmitTickets:function(e){try{var instance;if(e.preventDefault(),!$(evt.form_tickets).parsley().isValid())return;var jsonObj=$(evt.form_tickets).serializeJSON();if(0===Object.keys(jsonObj).length)return;console.log(jsonObj),""===jsonObj.ID?ticket.create(this,(function(self,model){null!==model&&!0===model.result?(console.log("submit tic ok"),evt.showListTicket(e),evt.loadTicketsCreateView()):console.log("submit tic pas ok")}),jsonObj):ticket.modify(this,(function(self,model){null!==model&&!0===model.result?(console.log("submit mod tic ok"),evt.showListTicket(e),evt.loadTicketsCreateView()):console.log("submit mod tic ok")}),jsonObj)}finally{e.preventDefault()}},onCreateTicket:function(e){$("#fcreateticket_id").val(""),$("#fcreateticket_name").val(""),$("#fcreateticket_descl").val(""),$("#fcreateticket_qte").val(""),$("#fcreateticket_price").val(""),$("#fcreateticket_minqte").val("1"),$("#fcreateticket_maxqte").val("10"),evt.showEditListTicket(e,"")},onEditTicket:function(e){var id=$(this).data("ticket-id"),jsonObj={UID:evt.uid,DATBEG:evt.datbeg,ID:id};ticket.getTicket(this,(function(self,model){null!==model&&!0===model.result&&($("#fcreateticket_id").val(model.data.ID),$("#fcreateticket_name").val(model.data.NAME),$("#fcreateticket_descl").val(model.data.DESCL),$("#fcreateticket_qte").val(model.data.QTE),$("#fcreateticket_price").val(model.data.PRICE),$("#fcreateticket_minqte").val(model.data.MINQTE),$("#fcreateticket_maxqte").val(model.data.MAXQTE),evt.showEditListTicket(e,id))}),jsonObj)},showListTicket:function(e){$("#fcreateticket_panel_create").css("display","none"),$("#btn_fcreateticket_save").css("display","none"),$("#btn_fcreateticket_save").prop("disabled",!0),$("#btn_fcreateticket_cancel").css("display","none"),$("#btn_fcreateticket_cancel").prop("disabled",!0),$("#fcreateticket_panel_view").css("display","block"),$("#btn_fcreateticket_create").css("display","block"),$("#btn_fcreateticket_create").prop("disabled",!1)},showEditListTicket:function(e,id){$("#fcreateticket_panel_create").css("display","block"),$("#btn_fcreateticket_save").css("display","block"),$("#btn_fcreateticket_save").prop("disabled",!1),$("#btn_fcreateticket_cancel").css("display","block"),$("#btn_fcreateticket_cancel").prop("disabled",!1),$("#fcreateticket_panel_view").css("display","none"),$("#btn_fcreateticket_create").css("display","none"),$("#fcreateticket_id").val(id)},onDeleteTickets:function(e){var txtConfirm=document.getElementById("text_alert_deleteticket").value,r;if(1==confirm(txtConfirm)){var id=$(this).data("ticket-id"),jsonObj={UID:evt.uid,DATBEG:evt.datbeg,ID:id};ticket.delete(this,(function(self,model){null!==model&&!0===model.result&&evt.loadTicketsCreateView()}),jsonObj)}},onChangeTicketsQte:function(e){var total=0,total_qte=0;$('select[name^="TICKET_QTE"]').each((function(){var cost=parseFloat($(this).data("ticket-price")),qte=parseFloat(this.value);qte>0&&(total_qte+=qte,total+=qte*cost)})),total_qte>0?$("#btn_checkout_tickets").prop("disabled",!1):$("#btn_checkout_tickets").prop("disabled",!0),$("#total_qte_tickets").text(total_qte),$("#total_price_tickets").text(Number(total).toLocaleString("fr-BE",{minimumFractionDigits:2})+" €")}};evt.init()}));