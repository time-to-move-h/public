"use strict";requirejs(["jquery","tippy","moment","moment/fr","doT","flow","parsley","jqsobject","app/modules/Channel","app/modules/Event","app/modules/Utils","app/modules/CropImage","app/modules/textEditor","c/tingle/tingle.min"],(function($,tippy,Moment,M_Lang,doT,Flow,Parsley,jqsobject,Channel,Event,Utils,CropImage,textEditor,tingle){var utils=new Utils,evt=new Event,cha=new Channel,channel={uid:null,firstLoad_events:!0,firstLoadPastEvents:!0,firstLoad_channels:!0,offset_events:0,offsetPastEvents:0,offset:0,lang:$("html").closest("[lang]").attr("lang")||"en",event_view_panel_empty:$("#event_view_panel_empty"),list_upcoming_events:$("#list_upcoming_events"),btn_loadmore_upcoming_events:$("#btn_loadmore_upcoming_events"),btn_loadmore_upcoming_past_events:$("#btn_loadmore_upcoming_past_events"),event_past_view_panel_empty:$("#event_past_view_panel_empty"),list_upcoming_past_events:$("#list_upcoming_past_events"),form_desc:"#fchanneldesc",modal_img:null,token:0,modal_desc:null,init:function(){var editor;(channel.uid=utils.getValueByID("UID"),$(document).on("click","#btn_loadmore_upcoming_events",(function(e){e.preventDefault(),channel.loadmore_events()})),$(document).on("click","#btn_loadmore_upcoming_past_events",(function(e){e.preventDefault(),channel.loadmore_past_events()})),$(document).on("click","#publish",(function(e){e.preventDefault(),channel.publish()})),$(document).on("click","#btn_descl_view_panel",(function(e){e.preventDefault(),$("#event_view_panel").css("display","none"),$("#descl_view_panel").css("display","block"),$("#btn_descl_view_panel").addClass("active"),$("#btn_event_view_panel").removeClass("active")})),$(document).on("click","#btn_event_view_panel",(function(e){e.preventDefault(),$("#event_view_panel").css("display","block"),$("#descl_view_panel").css("display","none"),$("#btn_event_view_panel").addClass("active"),$("#btn_descl_view_panel").removeClass("active")})),$(document).on("click","#btnsubscribe",(function(){channel.subscribe()})),$(document).on("click","#btnunsubscribe",(function(){channel.unsubscribe()})),$(document).on("click","#btnwaitconfirm",(function(){channel.unsubscribe()})),$(document).on("submit",channel.form_desc,channel.onSubmitDesc),evt.filter(this,this.onLoadEvents,{UID:channel.uid,O:this.offset_events,D:0}),evt.filter(this,this.onLoadPastEvents,{UID:channel.uid,O:this.offsetPastEvents,D:1}),document.getElementById("descl"))&&((new textEditor).init("#descl"),channel.initImage(),channel.initEditDesc())},initImage:function(){var cropimage=null,options_background={enableExif:!0,enableZoom:!0,showZoomer:!1,viewport:{width:851,height:315},boundary:{width:851,height:315}},options_avatar={enableExif:!0,enableZoom:!0,showZoomer:!1,viewport:{width:128,height:128},boundary:{width:300,height:300}};$("#btn_edit_background").on("click",(function(e){channel.token=$(e.target).attr("data-token"),channel.modal_img.open()})),$("#btn_edit_img_round").on("click",(function(e){channel.token=$(e.target).attr("data-token"),channel.modal_img.open()})),channel.modal_img=new tingle.modal({footer:!0,stickyFooter:!1,closeMethods:["overlay","button","escape"],closeLabel:"Close",cssClass:["custom"],onOpen:function(){document.getElementById("fchanneldesc")&&((cropimage=new CropImage).setUid(channel.uid),cropimage.setUploadToken(channel.token),cropimage.setUploadCropZone($("#upload-demo")),$("#upload").on("change",(function(){var result;!0===cropimage.readFile(this)&&$("#upload_btn_save").css("visibility","visible")})),cropimage.setCallBack((function(message){var msg=JSON.parse(message);!0===msg.success&&("5471"===channel.token&&(document.getElementById("back_img").src=msg.flowIdentifier),$("#upload_btn_save").css("visibility","hidden"),channel.modal_img.close())})),$(".upload-result").on("click",(function(e){cropimage.crop()})),"5471"===channel.token?cropimage.setOptions(options_background):"6356"===channel.token&&cropimage.setOptions(options_avatar),$("#upload_btn_save").css("visibility","hidden"),cropimage.setUploadCropZone($("#upload-demo")))},onClose:function(){},beforeClose:function(){return!0}}),channel.modal_img.setContent(document.getElementById("panel_edit_img").innerHTML)},initEditDesc:function(){$("#btn_edit_desc").on("click",(function(e){channel.modal_desc.open()})),channel.modal_desc=new tingle.modal({footer:!0,stickyFooter:!1,closeMethods:["overlay","button","escape"],closeLabel:"Close",cssClass:["custom"],onOpen:function(){},onClose:function(){},beforeClose:function(){return!0}}),channel.modal_desc.setContent(document.getElementById("panel_channel_edit_desc").innerHTML)},onSubmitDesc:function(e){try{var instance;if(!$(channel.form_desc).parsley().isValid())return;var jsonObj=$(channel.form_desc).serializeJSON(),data_descl=$(".ql-editor").html();if(jsonObj.DESCL=data_descl,0===Object.keys(jsonObj).length)return;cha.modifyChannelDesc(self,(function(self,model){null!==model&&!0===model.result&&($("#modal_edit_desc").modal("hide"),window.location.reload(!0))}),jsonObj)}finally{e.preventDefault()}},isEventData:function(){return document.getElementById("list_upcoming_events").innerHTML.length},isPastEventData:function(){return document.getElementById("list_upcoming_past_events").innerHTML.length},onLoadEvents:function(self,model){if(null!==model&&!0===model.result)if(model.data.length>0){!0===self.firstLoad_events&&(model.data.length<9?self.btn_loadmore_upcoming_events.css("display","none"):self.btn_loadmore_upcoming_events.css("display","block")),channel.event_view_panel_empty.css("display","none");var surl=window.location.pathname,lang=utils.getUserLanguage(),tmpl=document.getElementById("tpl_evt").innerHTML,tempFn=doT.template(tmpl);$.each(model.data,(function(){var evtUrl=lang+"/event/"+this.URLLINK,LOGO=this.PICTURE,PICTURE="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";null!=LOGO&&LOGO.length>0&&(PICTURE=LOGO);var a=Moment(this.DATBEG);a.locale("fr");var resultText=tempFn({TITLE:this.TITLE,DATBEG:a.locale("fr").format("dddd, DD MMMM YYYY HH:mm"),DAY:a.format("DD"),MONTH:a.format("MMMM"),SUBSCRIPTION:this.SUBSCRIPTION,URLLINK:this.URLLINK,PICTURE:PICTURE,EVTURL:evtUrl});channel.list_upcoming_events.append(resultText)}))}else channel.btn_loadmore_upcoming_events.css("display","none"),channel.isEventData()<=0&&channel.event_view_panel_empty.css("display","block")},onLoadPastEvents:function(self,model){if(null!==model&&!0===model.result)if(model.data.length>0){!0===self.firstLoadPastEvents&&(model.data.length<9?self.btn_loadmore_upcoming_past_events.css("display","none"):self.btn_loadmore_upcoming_past_events.css("display","block")),self.event_past_view_panel_empty.css("display","none");var lang=utils.getUserLanguage(),tmpl=document.getElementById("tpl_evt").innerHTML,tempFn=doT.template(tmpl);$.each(model.data,(function(){var a=Moment(this.DATBEG);a.locale("fr");var resultText=tempFn({TITLE:this.TITLE,DATBEG:a.locale("fr").format("dddd, DD MMMM YYYY HH:mm"),DAY:a.format("DD"),MONTH:a.format("MMMM"),SUBSCRIPTION:this.SUBSCRIPTION,URLLINK:this.URLLINK});self.list_upcoming_past_events.append(resultText)}))}else channel.btn_loadmore_upcoming_past_events.css("display","none"),channel.isPastEventData()<=0&&channel.event_past_view_panel_empty.css("display","block")},onPublishChannel:function(self,model,jsonObj){null!==model&&!0===model.result?$("#panel-pub").hide():$("#btnPublish").prop("disabled",!0)},publish:function(){$("#publish").prop("disabled",!0),cha.publish(self,this.onPublishChannel,{UID:channel.uid})},subscribe:function(){var jsonObj={UID:channel.uid};$("#btnsubscribe").prop("disabled",!0),cha.subscribe(this,(function(self,model){null!==model&&!0===model.result&&($("#btnsubscribe").css("display","none"),$("#btnwaitconfirm").css("display","none"),$("#btnunsubscribe").css("display","block")),$("#btnsubscribe").prop("disabled",!1)}),jsonObj)},unsubscribe:function(){var r;if(1==confirm("are you sure you want to unsubscribe ?")){var jsonObj={UID:channel.uid};$("#btnsubscribe").prop("disabled",!0),cha.unsubscribe(self,(function(self,model){null!==model&&!0===model.result&&($("#btnwaitconfirm").css("display","none"),$("#btnunsubscribe").css("display","none"),$("#btnsubscribe").css("display","block")),$("#btnsubscribe").prop("disabled",!1)}),jsonObj)}},loadmore_events:function(){channel.firstLoad_events=!1,channel.offset_events++,evt.filter(channel,channel.onLoadEvents,{UID:channel.uid,O:this.offset_events,D:0})},loadmore_past_events:function(){channel.firstLoadPastEvents=!1,channel.offsetPastEvents++,evt.filter(channel,channel.onLoadPastEvents,{UID:channel.uid,O:channel.offsetPastEvents,D:1})}};channel.init()}));